<?php
/**
 * Field API implementations
 */
include_once('cmtls.fields.inc');

/**
 * Context API implementations
 */
include_once('cmtls.contexts.inc');

/**
 * Views API implementations
 */
include_once('cmtls.views.inc');

/**
 * Implementation of hook_ctools_plugin_api().
 */
function cmtls_ctools_plugin_api() {
  list($module, $api) = func_get_args();
  if ($module == "context" && $api == "context") {
    return array("version" => "3");
  }
  if ($module == 'ds' && $api == 'ds') {
    return array('version' => 1);
  }
}

/**
 * Implementation of hook_views_api().
 */
function cmtls_views_api() {
  list($module, $api) = func_get_args();
  if ($module == "views" && $api == "views_default") {
    return array("version" => "3.0");
  }
}

/**
 * Implementation of hook_node_info().
 */
function cmtls_node_info() {
  $items = array(
    'cmtls_group' => array(
      'name' => t('CT Group'),
      'base' => 'node_content',
      'description' => t('Community Tools group, Organic Groups.'),
      'has_title' => '1',
      'title_label' => t('Title'),
      'help' => '',
    ),
    'cmtls_app' => array(
      'name' => t('CT Application'),
      'base' => 'node_content',
      'description' => t('Community Tools application, defines the content type etc'),
      'has_title' => '1',
      'title_label' => t('Title'),
      'help' => '',
    ),
    'cmtls_location' => array(
      'name' => t('CT Location'),
      'base' => 'node_content',
      'description' => t('Community Tools locations'),
      'has_title' => '1',
      'title_label' => t('Title'),
      'help' => '',
    ),
  );
  return $items;
}

/** 
 * Implements hook_node_load().
 * 
 * adds a 'cmtls_app_type' to node object if it has one defined
 * adds global variable about current application
 */
function cmtls_node_load($nodes, $types) {
  // TODO: a better way to detect if a node has field 'cmtls_app_type' attached, currently hardcoded
  $node_types = array_keys(cmtls_get_app_content_types());
  foreach ($nodes as $nid => &$node) {
    if($node->type == 'cmtls_app') { // hardcoded node type
       // hardcoded node field for app types
      if(!isset($node->field_cmtls_app_type[LANGUAGE_NONE][0]['cmtls_app_type'])) continue; //
      $node->cmtls_app_type = $node->field_cmtls_app_type[LANGUAGE_NONE][0]['cmtls_app_type'];
      cmtls_add_conf('current_app', $node);
      break;
    }
    elseif(isset($node->field_cmtls_application) && $node->field_cmtls_application && $node->field_cmtls_application[LANGUAGE_NONE][0]['nid'] && in_array($node->type, $node_types)) {
      cmtls_add_conf('current_app', node_load($node->field_cmtls_application[LANGUAGE_NONE][0]['nid']));
      break;
    }
  }
}

/**
 * Implement hook_menu().
 */
function cmtls_menu() {
  $items = array();

  // creates the add contextual task / link
  $items['node/%node/cmtls/add'] = array(
    'title' => t('Add'),
    'title callback' => 'cmtls_add_content_title',
    'title arguments' => array(1),
    'page callback' => 'cmtls_add_content_page',
    'page arguments' => array(1),
    'access callback' => 'cmtls_create_content_access',
    'access arguments' => array(1),
    'description' => t('Add content'),
    'type' => MENU_LOCAL_TASK,
    'context' => MENU_CONTEXT_PAGE | MENU_CONTEXT_INLINE,
  );
  
  // creates autocomplete for locations
  $items['cmtls/location/ac'] = array(
    'title' => t('Location matching'),
    'page callback' => 'cmtls_location_autocomplete',
    'access arguments' => array('view content'),
    'type' => MENU_CALLBACK,
  );
  
  return $items;
}

function cmtls_get_app_content_types($module = NULL) {
  static $types;
  if($types && !$module) {
    return $types;
  }
  
  $types = array();
  
  $apps = module_invoke_all('cmtls_app');
  
  foreach ($apps as $m => $config) {
    if(isset($config['node types'])) $types += $config['node types'];
    if($module == $m) {
      if(isset($config['node types'])) return $config['node types'];
      else return array();
    }
  }
  
  return $types;
}

function cmtls_add_content_title($parent) {
  if($parent->type == 'cmtls_group') {
    return t('Add application');
  }
  elseif($parent->type == 'cmtls_app' && $content_types = cmtls_get_app_content_types($parent->cmtls_app_type)) {
    return t('Add '.implode(',', $content_types));
  }
  elseif($content_types = cmtls_get_app_content_types()) {
    return t('Add '.$content_types[$parent->type]);
  }
  else {
    return NULL;
  }
}

/**
 * Add content contextual link access
 */
function cmtls_create_content_access($parent) {
  $access = FALSE;
      
  if($parent->type == 'cmtls_group') {
    $access = node_access('create', 'cmtls_app');
  }
  elseif($parent->type == 'cmtls_app') {
    if($content_types = array_keys(cmtls_get_app_content_types($parent->cmtls_app_type))) {
      $access = node_access('create', array_pop($content_types)); // multiple types yet to resolve
    }
  }
  else {
    $access = node_access('create', $parent->type);
  }
  
  return $access;
}

/**
 * Wrapper page function for node form, to set variables for default group and application variables
 */
function cmtls_add_content_page($parent) {
  module_load_include('inc', 'node', 'node.pages');
  
  global $user;
  
  $types = node_type_get_types();
  $content_types = cmtls_get_app_content_types();
  
  $node = (object) array(
    'uid' => $user->uid,
    'name' => (isset($user->name) ? $user->name : ''),
    'language' => LANGUAGE_NONE,
  );
  
  // menu link preselect for apps
  if($parent->type == 'cmtls_group') {
    $query = db_select('menu_node', 'menu_node')
      ->fields('menu_node', array('mlid'))
      ->condition('menu_node.nid', $parent->nid, '=')
      ->condition('menu_links.menu_name', 'menu-cmtls', '=');
    $query->join('menu_links', 'menu_links', 'menu_node.mlid = menu_links.mlid');
    $mlid = $query->execute()->fetchField();
    $node->cmtls_menu_preselect = $mlid;
  }
  
  // group preselect for apps
  if($parent->type == 'cmtls_group') {
    $type = $node->type = 'cmtls_app';
    $groups = og_get_group_ids('node', array($parent->nid));
    $node->cmtls_group_preselect = $groups[$parent->nid];
  }
  // group and app preselect for content nodes
  elseif($parent->type == 'cmtls_app') {
    $type = $node->type = array_pop(array_keys(cmtls_get_app_content_types($parent->cmtls_app_type)));  // multiple types yet to resolve
    $node->cmtls_group_preselect = $parent->group_audience[LANGUAGE_NONE][0]['gid'];
    $node->cmtls_parent_preselect = $parent->nid;
  }
  // group and app preselect for content nodes
  elseif(in_array($parent->type, array_keys(cmtls_get_app_content_types()))) {
    $type = $node->type = $parent->type;
    $node->cmtls_group_preselect = $parent->group_audience[LANGUAGE_NONE][0]['gid'];
    $node->cmtls_parent_preselect = $parent->field_cmtls_application[LANGUAGE_NONE][0]['nid'];
  }
  drupal_set_title(t('Create @name', array('@name' => $types[$type]->name)), PASS_THROUGH);
  $output = drupal_get_form($type . '_node_form', $node);

  return $output;
}

/**
 * Implements hook_form_alter().
 * 
 * preselects menu and app for CT content nodes
 */
function cmtls_form_node_form_alter(&$form, &$form_state, $form_id) {
  $app_form_ids = array();
  foreach (cmtls_get_app_content_types() as $app_type => $app) {
    $app_form_ids[] = $app_type . '_node_form';
  }
  
  // preselect app menu link
  if(($form_id == 'cmtls_app_node_form') && !empty($form['#node']->cmtls_menu_preselect)) {
    $form['menu']['link']['parent']['#default_value'] = 'menu-cmtls:' . $form['#node']->cmtls_menu_preselect;
    $form['menu']['enabled']['#default_value'] = 1;
  }
  
  // preselect group audience
  if(($form_id == 'cmtls_app_node_form' || in_array($form_id, $app_form_ids)) && !empty($form['#node']->cmtls_group_preselect)) {
    $form['group_audience'][LANGUAGE_NONE]['#default_value'][$form['#node']->cmtls_group_preselect] = $form['#node']->cmtls_group_preselect;
  }

  // preselect parent application
  if(in_array($form_id, $app_form_ids) && !empty($form['#node']->cmtls_parent_preselect)) {
    $form['field_cmtls_application'][LANGUAGE_NONE]['#default_value'][] = $form['#node']->cmtls_parent_preselect;
  }
}

/**
 * Implements hook_form_FORM_ID_alter().
 * 
 * removes the main group field from node form
 * adds autocomplete for the location
 */
function cmtls_form_cmtls_group_node_form_alter(&$form, &$form_state, $form_id) {
  global $user; 
  // allow only for the root user
  if($user->uid != 1) {
    $form['field_cmtls_main_group'] = NULL;
  }
  
  drupal_add_js(drupal_get_path('module', 'cmtls') . '/js/cmtls.location_ac.js');
}

/**
 * Implements hook_form_FORM_ID_alter().
 * 
 * inserts the app configuration fields
 * @see cmtls_form_config_save()
 */
function cmtls_form_cmtls_app_node_form_alter(&$form, &$form_state, $form_id) {
  
  global $user;
  
  $current_config = array();
  
  if(!empty($form['#node']->field_cmtls_app_configs[LANGUAGE_NONE][0]['value'])) {
    $current_config = unserialize($form['#node']->field_cmtls_app_configs[LANGUAGE_NONE][0]['value']);
  }
  
  $configs = module_invoke_all('cmtls_app_config', $current_config);
  
  $form['cmtls_app_configs'] = array();
  
  if(!empty($configs)) {
    $form['cmtls_app_configs'] = $configs;
    $form['cmtls_app_configs']['#weight'] = $form['field_cmtls_app_type']['#weight'] + 1;
    $form['#submit'][] = 'cmtls_form_config_save';
  }
  
  if($user->uid != 1) {
    $form['field_cmtls_app_configs']['#type'] = 'hidden';
  }
  
  // TODO: hide application selection on already existing node to improve usability
  //if(isset($form['#node']->nid) && $form['#node']->nid) $form['field_cmtls_app_type']['#type'] = 'hidden';
}

/**
 * App node form submit, saves app instance configuration values
 */
function cmtls_form_config_save($form, &$form_state) {
  if(!empty($form['cmtls_app_configs'])) {
    // save app config
    $app_config = array();
    
    foreach ($form['cmtls_app_configs'] as $module => &$configs) if(strpos($module, '#') !== 0) {
      // for now only single level form values are counted
      foreach ($form['cmtls_app_configs'][$module] as $key => &$config) if(strpos($key, '#') !== 0) {
        $app_config[$module][$key] = $config['#value'];
      }
    }
    
    if(!empty($app_config)) {
      $form['field_cmtls_app_configs'][LANGUAGE_NONE][0]['value']['#value'] = $form_state['values']['field_cmtls_app_configs'][LANGUAGE_NONE][0]['value'] = serialize($app_config);
    }
  }
}

/**
 * Adds global values to Drupal $conf['cmtls']
 */
function cmtls_add_conf($key, &$value) {
  global $conf;
  
  if(!isset($conf['cmtls'])) $conf['cmtls'] = array();
  if(!isset($conf['cmtls'][$key])) $conf['cmtls'][$key] = NULL;
  $conf['cmtls'][$key] = $value;
}

/**
 * returns current app object
 */
function cmtls_get_current_app() {
  global $conf;
  if(isset($conf['cmtls']['current_app'])) return $conf['cmtls']['current_app'];
  else return NULL;
}

/**
 * returns the app custom configuration values
 */
function cmtls_get_app_config($app = NULL) {
  if(!$app) $app = cmtls_get_current_app();
  if(isset($app->field_cmtls_app_configs[LANGUAGE_NONE][0]['value'])) return unserialize($app->field_cmtls_app_configs[LANGUAGE_NONE][0]['value']);
  else return array();
}

/**
 * returns user full name
 * 
 * @todo make this configurable with tokens, perhaps independent module
 */
function cmtls_get_username($account) {
  if(isset($account->field_first_name[LANGUAGE_NONE][0]['safe_value']) && $account->field_first_name[LANGUAGE_NONE][0]['safe_value']) {
    $name = $account->field_first_name[LANGUAGE_NONE][0]['safe_value'];
    if(isset($account->field_last_name[LANGUAGE_NONE][0]['safe_value']) && $account->field_last_name[LANGUAGE_NONE][0]['safe_value']) {
      $name .= ' '.$account->field_last_name[LANGUAGE_NONE][0]['safe_value'];
    }
    
    return $name;
  }
  else {
    return $account->name;
  }
}

/**
 * implements hook_username_alter()
 * changes the username to full users name
 */
function cmtls_username_alter(&$name, &$account) {
  $name = cmtls_get_username($account);
}

/**
 * implements hook_preprocess_username()
 * changes the username to full users name
 */
function cmtls_preprocess_username(&$variables) {
  $variables['name_raw'] = $variables['name'] = cmtls_get_username(user_load($variables['uid']));
}

/**
 * Implements hook_form_FORM_ID_alter().
 * 
 * adds new user registrations to the main CT group
 * @see cmtls_user_register_add_to_main_group
 */
function cmtls_form_user_register_form_alter(&$form, &$form_state, $form_id) {
  $form['#submit'][] = 'cmtls_user_register_add_to_main_group';
}

/**
 * adds new user registrations to the main CT group
 */
function cmtls_user_register_add_to_main_group($form, &$form_state) {
  $query = db_select('field_data_field_cmtls_main_group', 'field_data_field_cmtls_main_group')
    ->fields('og', array('gid'))
    ->condition('field_data_field_cmtls_main_group.field_cmtls_main_group_value', 1, '=')
    ->range(0, 1);
  $query->join('og', 'og', 'field_data_field_cmtls_main_group.entity_id = og.etid');
  $group = $query->execute()->fetchAssoc();
  if(count($group)) {
    $values = array(
      'entity' => $form['#user'],
    );
    og_group($group['gid'], $values);
  }
}

/**
 * Implements hook_cmtls_app_config
 * 
 * adds location configuration options
 */
function cmtls_cmtls_app_config($config) {
    
  $defaults = array(
    'sorting_field' => 'node_title',
    'sorting_dir' => 'ASC'
  );
  
  $settings = array_merge($defaults, isset($config['cmtls_location']) ? $config['cmtls_location'] : array());
  
  $form['cmtls_location'] = array(
    '#type' => 'fieldset',
    '#title' => t('Sorting settings'),
    '#collapsible' => TRUE,
    '#states' => array(
      'visible' => array(
        ':input[name="field_cmtls_app_type['.LANGUAGE_NONE.'][0][cmtls_app_type]"]' => array('value' => 'cmtls_location'),
      ),
    ),
  );

  $form['cmtls_location']['sorting_field'] = array(
    '#type' => 'radios',
    '#title' => t('Sorting field'),
    '#default_value' => $settings['sorting_field'],
    '#options' => array(
      'node_created' => t('Created date'),
      'node_title' => t('Location title'),
    ),
  );
  
  $form['cmtls_location']['sorting_dir'] = array(
    '#type' => 'radios',
    '#title' => t('Sorting order'),
    '#default_value' => $settings['sorting_dir'],
    '#options' => array(
      'ASC' => t('Ascending'),
      'DESC' => t('Descending'),
    ),
  );

  return $form;
}

/**
 * Implements hook_cmtls_app
 * 
 * adds location app type
 */
function cmtls_cmtls_app() {
  return array(
    'cmtls' => array(
      'title' => t('Locations'),
      'description' => t('Locations'),
      'node types' => array(
        'cmtls_location' => t('Location'),
      ),
    ),
  );
}

/**
 * implements hook_location_element_alter()
 * 
 * adds location autocomplete to the location name field
 */
function cmtls_location_element_alter(&$element) {
  $element['name']['#attributes']['class'][] = 'cmtls-location-autocomplete';
  drupal_add_library('system', 'ui.autocomplete');  
}

/**
 * Autocompletes locations
 */
function cmtls_location_autocomplete($string = '') {
  $matches = array();
  
  if(strlen($string) > 1) {
    $query = db_select('location', 'location')
      ->fields('field_data_field_cmtls_location', array('entity_type', 'entity_id'))
      ->fields('location')
      ->condition('field_data_field_cmtls_location.bundle', 'cmtls_location', '=')
      ->condition('location.name', $string.'%', 'LIKE')
      ->range(0, 5);
    $query->join('field_data_field_cmtls_location', 'field_data_field_cmtls_location', 'location.lid = field_data_field_cmtls_location.field_cmtls_location_lid');
    $result = $query->execute();
    
    while($location = $result->fetchAssoc()) {
      // check for permissions ... is this right?
      if(entity_load_single($location['entity_type'], $location['entity_id'])) {
        if(isset($location['latitude']) && $location['latitude'] != 0.000000) {
          $location['locpick-user-latitude'] = $location['latitude'];
        }
        if(isset($location['longitude']) && $location['longitude'] != 0.000000) {
          $location['locpick-user-longitude'] = $location['longitude'];
        }
        $matches[] = $location;
      }
    }
  }
  
  drupal_json_output($matches);
}
